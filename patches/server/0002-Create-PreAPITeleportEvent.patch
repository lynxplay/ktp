From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Bjarne Koll <lynxplay101@gmail.com>
Date: Sun, 3 Jan 2021 17:58:31 +0100
Subject: [PATCH] Create PreAPITeleportEvent

As spigot api teleportation is subject to stricter checks than the
default minecraft teleportation, some plugins may not be able to
teleport entities that would be perfectly fine teleporting under the
vanilla standart.

To not remove the created rules by spigot and potentially break plugin
compatibility the PreAPITeleportEvent is called prior to most checks
executed by spigot which allows plugins to modify potential target
entities that are teleported by other plugins prior to the checks.

diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 475dc1aa2cba77c13033938e719a66707f358914..558d3b6fd4c2ea082f320d6828b99dd38cda0241 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -540,9 +540,11 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         Preconditions.checkArgument(location != null, "location");
         location.checkFinite();

-        if (entity.isVehicle() || entity.dead) {
-            return false;
-        }
+        // ktp start - Call pre api teleport / move dead check above event to respect definition of event
+        if (entity.dead) return false;
+        server.getPluginManager().callEvent(new org.bukkit.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause));
+        if (entity.isVehicle()) return false;
+        // ktp stop - Call pre api teleport

         // If this entity is riding another entity, we must dismount before teleporting.
         entity.stopRiding();
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 58caa3240b90cdc661e1e32e3f5c312ed62c3c21..783c65f8c057834718492e09ef9f767c793b0561 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -785,6 +785,9 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         if (getHealth() == 0 || entity.dead) {
             return false;
         }
+        // ktp start - Call pre api teleport
+        server.getPluginManager().callEvent(new org.bukkit.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause));
+        // ktp stop - Call pre api teleport

         if (entity.playerConnection == null) {
            return false;
